<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Hibrit PPTX Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        .hybrid-container {
            display: flex;
            gap: 20px;
            padding: 20px;
        }
        
        .pdf-viewer {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f5f5f5;
        }
        
        #slideCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        #elementOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .element-overlay {
            position: absolute;
            border: 2px dashed transparent;
            pointer-events: all;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .element-overlay:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .metadata-panel {
            width: 400px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            max-height: 80vh;
        }
        
        .ai-controls {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
        }
        
        .ai-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .ai-button {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .ai-button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="hybrid-container">
        <!-- PDF Viewer -->
        <div class="pdf-viewer">
            <canvas id="slideCanvas"></canvas>
            <div id="elementOverlay"></div>
        </div>
        
        <!-- Metadata Panel -->
        <div class="metadata-panel">
            <h2>Slide Metadata</h2>
            <div id="metadataContent"></div>
            
            <!-- AI Controls -->
            <div class="ai-controls">
                <h3>AI Düzenleme</h3>
                <input 
                    type="text" 
                    id="aiInstruction" 
                    class="ai-input" 
                    placeholder="Örn: Başlığı 'Yeni Başlık' olarak değiştir"
                />
                <button class="ai-button" onclick="applyAIEdit()">
                    AI ile Düzenle
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let pdfDoc = null;
        let currentSlideIndex = 0;
        let slideMetadata = [];
        
        // File input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.pptx';
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                await loadPresentationHybrid(file);
            }
        };
        document.body.insertBefore(fileInput, document.body.firstChild);
        
        async function loadPresentationHybrid(pptxFile) {
            // 1. Convert to PDF
            const pdfBlob = await convertPptxToPdf(pptxFile);
            pdfDoc = await pdfjsLib.getDocument(URL.createObjectURL(pdfBlob)).promise;
            
            // 2. Extract metadata (simplified - use your existing app.js logic)
            // For now, we'll use a placeholder
            slideMetadata = []; // TODO: Extract from PPTX using app.js logic
            
            // 3. Render first slide
            await renderSlideHybrid(0);
        }
        
        async function renderSlideHybrid(slideIndex) {
            const canvas = document.getElementById('slideCanvas');
            const ctx = canvas.getContext('2d');
            
            const page = await pdfDoc.getPage(slideIndex + 1);
            const viewport = page.getViewport({ scale: 2 });
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
            
            // Update metadata display
            updateMetadataDisplay(slideIndex);
        }
        
        function updateMetadataDisplay(slideIndex) {
            const content = document.getElementById('metadataContent');
            const slide = slideMetadata[slideIndex] || { elements: [] };
            
            content.innerHTML = `
                <h3>Slide ${slideIndex + 1}</h3>
                <p><strong>Elements:</strong> ${slide.elements?.length || 0}</p>
                <pre>${JSON.stringify(slide, null, 2)}</pre>
            `;
        }
        
        async function convertPptxToPdf(pptxFile) {
            const buffer = await pptxFile.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            
            const response = await fetch('http://localhost:3000/convert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fileName: pptxFile.name,
                    fileData: base64,
                    type: 'pptx-to-pdf'
                })
            });
            
            return await response.blob();
        }
        
        async function applyAIEdit() {
            const instruction = document.getElementById('aiInstruction').value;
            if (!instruction) return;
            
            // AI agent'a gönder
            await aiEditSlide(currentSlideIndex, instruction);
        }
        
        async function aiEditSlide(slideIndex, instruction) {
            // TODO: AI agent entegrasyonu
            console.log('AI edit:', slideIndex, instruction);
            alert('AI düzenleme özelliği yakında eklenecek!');
        }
    </script>
</body>
</html>

